workflows:
  ios_release:
    name: iOS Release (TestFlight)
    max_build_duration: 60

    environment:
      flutter: stable
      xcode: latest
      cocoapods: default
      vars:
        # <-- Gerçek bundle ID'n (App ID)
        APP_ID: "com.tasdemir.habitfree"

    triggers:
      # Git tag push'larında otomatik çalışsın (örn. v1.0.0)
      tag: true

    scripts:
      - name: Flutter clean & pub get
        script: |
          flutter --version
          flutter clean
          flutter pub get

      - name: Set iOS Bundle Identifier
        script: |
          echo "Setting Bundle ID to $APP_ID"
          # Xcode projesindeki tüm com.example.bagimliss geçişlerini APP_ID ile değiştir
          sed -i '' "s/com\.example\.bagimliss/$APP_ID/g" ios/Runner.xcodeproj/project.pbxproj

      - name: Set up iOS code signing (App Store Connect)
        script: |
          # İmzalama için keychain'i hazırla
          keychain initialize
          # App Store (distribution) tipi sertifika & provisioning profilleri indir/oluştur
          app-store-connect fetch-signing-files "$APP_ID" --type IOS_APP_STORE --create
          # Sertifikaları keychain'e ekle ve profilleri projeye uygula
          keychain add-certificates
          xcode-project use-profiles

      - name: Ensure CocoaPods deps
        script: |
          cd ios
          pod install --repo-update
          cd ..

      - name: Build iOS (release IPA)
        script: |
          BUILD_NAME=${CM_TAG:-1.0.0}
          flutter build ipa --release \
            --build-name="$BUILD_NAME" --build-number="$CM_BUILD_ID"

    publishing:
      app_store_connect:
        submit_to_testflight: true
        beta_groups:
          - Internal Testing
